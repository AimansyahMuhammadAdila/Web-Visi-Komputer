{% extends "base.html" %}

{% block title %}Tugas 3 - Decision Tree Classification{% endblock %}

{% block extra_scripts %}
<script>
    let csvData = null;

    function handleCSVUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
            csvData = e.target.result;
            const lines = csvData.split('\n').filter(line => line.trim());
            const cols = lines[0].split(',').length;

            document.getElementById('csvFileName').textContent = file.name;
            document.getElementById('csvRows').textContent = lines.length - 1;
            document.getElementById('csvCols').textContent = cols;
            document.getElementById('csvInfo').style.display = 'block';
            document.getElementById('btnProcessDT').disabled = false;

            // Show preview
            showDataPreview(csvData);
        };
        reader.readAsText(file);
    }

    function showDataPreview(csvData) {
        const lines = csvData.split('\n').filter(line => line.trim()).slice(0, 6);
        let html = '<table class="preview-table">';
        lines.forEach((line, index) => {
            html += '<tr>';
            line.split(',').forEach(cell => {
                if (index === 0) {
                    html += `<th>${cell}</th>`;
                } else {
                    html += `<td>${cell}</td>`;
                }
            });
            html += '</tr>';
        });
        html += '</table>';
        document.getElementById('dataPreviewContent').innerHTML = html;
        document.getElementById('dataPreview').style.display = 'block';
    }

    function processDecisionTree() {
        if (!csvData) {
            alert('Silakan upload file CSV terlebih dahulu!');
            return;
        }

        const test_size = parseFloat(document.getElementById('test_size_dt').value);
        const max_depth = document.getElementById('max_depth_dt').value;

        document.getElementById('loadingDT').style.display = 'block';
        document.getElementById('resultDT').style.display = 'none';

        fetch('/predict_decision_tree', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                csv_data: csvData,
                test_size: test_size,
                max_depth: max_depth === 'None' ? null : max_depth
            })
        })
            .then(response => response.json())
            .then(data => {
                document.getElementById('loadingDT').style.display = 'none';

                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }

                displayDecisionTreeResults(data);
                document.getElementById('resultDT').style.display = 'block';
            })
            .catch(error => {
                document.getElementById('loadingDT').style.display = 'none';
                alert('Terjadi kesalahan: ' + error);
            });
    }

    function displayDecisionTreeResults(data) {
        let html = `
        <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 25px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);">
            <div style="text-align: center;">
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px;">üéØ Akurasi Model</div>
                <div style="font-size: 42px; font-weight: bold; margin: 10px 0;">${(data.accuracy * 100).toFixed(2)}%</div>
                <div style="font-size: 13px; opacity: 0.9;">Decision Tree Classifier</div>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 25px;">
            <div class="stat-card" style="background: white; padding: 15px; border-radius: 12px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid #e2e8f0;">
                <div style="font-size: 24px; margin-bottom: 5px;">üå≤</div>
                <div style="color: #64748b; font-size: 12px; font-weight: 600;">MAX DEPTH</div>
                <div style="font-size: 20px; font-weight: 800; color: #1e293b;">${data.tree_info.max_depth || '‚àû'}</div>
            </div>
            <div class="stat-card" style="background: white; padding: 15px; border-radius: 12px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid #e2e8f0;">
                <div style="font-size: 24px; margin-bottom: 5px;">üçÉ</div>
                <div style="color: #64748b; font-size: 12px; font-weight: 600;">LEAF NODES</div>
                <div style="font-size: 20px; font-weight: 800; color: #1e293b;">${data.tree_info.n_leaves}</div>
            </div>
            <div class="stat-card" style="background: white; padding: 15px; border-radius: 12px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid #e2e8f0;">
                <div style="font-size: 24px; margin-bottom: 5px;">üìä</div>
                <div style="color: #64748b; font-size: 12px; font-weight: 600;">TOTAL SAMPLES</div>
                <div style="font-size: 20px; font-weight: 800; color: #1e293b;">${data.dataset_info.total_samples}</div>
            </div>
            <div class="stat-card" style="background: white; padding: 15px; border-radius: 12px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid #e2e8f0;">
                <div style="font-size: 24px; margin-bottom: 5px;">üè∑Ô∏è</div>
                <div style="color: #64748b; font-size: 12px; font-weight: 600;">CLASSES</div>
                <div style="font-size: 20px; font-weight: 800; color: #1e293b;">${data.dataset_info.num_classes}</div>
            </div>
        </div>

        <div class="result-section" style="background: #fff; padding: 25px; border-radius: 16px; margin-bottom: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid #e2e8f0;">
            <h4 style="margin-top: 0; color: #1e293b; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                <span style="background: #e0e7ff; color: #4338ca; padding: 8px; border-radius: 8px;">‚≠ê</span>
                Feature Importances
            </h4>
            <div style="display: flex; flex-direction: column; gap: 15px;">
    `;

        data.feature_importances.forEach(item => {
            const percentage = (item.importance * 100).toFixed(1);
            html += `
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="width: 120px; font-weight: 600; color: #475569; font-size: 14px;">${item.feature}</div>
                    <div style="flex: 1; height: 10px; background: #f1f5f9; border-radius: 20px; overflow: hidden;">
                        <div style="width: ${percentage}%; height: 100%; background: linear-gradient(90deg, #6366f1 0%, #818cf8 100%); border-radius: 20px;"></div>
                    </div>
                    <div style="width: 60px; text-align: right; font-weight: 700; color: #6366f1;">${item.importance.toFixed(4)}</div>
                </div>
            `;
        });

        html += `
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 25px; margin-bottom: 25px;">
             <div class="result-section" style="background: #fff; padding: 25px; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid #e2e8f0;">
                <h4 style="margin-top: 0; color: #1e293b; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                    <span style="background: #fce7f3; color: #db2777; padding: 8px; border-radius: 8px;">üìà</span>
                     Class Metrics
                </h4>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: separate; border-spacing: 0;">
                        <thead>
                            <tr style="background: #f8fafc;">
                                <th style="padding: 12px; text-align: left; font-size: 12px; color: #64748b; border-bottom: 2px solid #e2e8f0;">CLASS</th>
                                <th style="padding: 12px; text-align: center; font-size: 12px; color: #64748b; border-bottom: 2px solid #e2e8f0;">PRECISION</th>
                                <th style="padding: 12px; text-align: center; font-size: 12px; color: #64748b; border-bottom: 2px solid #e2e8f0;">RECALL</th>
                                <th style="padding: 12px; text-align: center; font-size: 12px; color: #64748b; border-bottom: 2px solid #e2e8f0;">F1-SCORE</th>
                            </tr>
                        </thead>
                        <tbody>
        `;

        data.class_metrics.forEach(metric => {
            html += `
                <tr>
                    <td style="padding: 12px; font-weight: 600; color: #334155; border-bottom: 1px solid #f1f5f9;">${metric.class}</td>
                    <td style="padding: 12px; text-align: center; border-bottom: 1px solid #f1f5f9;">
                         <span style="background: #ecfdf5; color: #059669; padding: 4px 8px; border-radius: 6px; font-size: 13px; font-weight: 600;">${(metric.precision * 100).toFixed(1)}%</span>
                    </td>
                    <td style="padding: 12px; text-align: center; border-bottom: 1px solid #f1f5f9;">
                        <span style="background: #eff6ff; color: #2563eb; padding: 4px 8px; border-radius: 6px; font-size: 13px; font-weight: 600;">${(metric.recall * 100).toFixed(1)}%</span>
                    </td>
                    <td style="padding: 12px; text-align: center; border-bottom: 1px solid #f1f5f9;">
                        <span style="background: #f5f3ff; color: #7c3aed; padding: 4px 8px; border-radius: 6px; font-size: 13px; font-weight: 600;">${(metric.f1_score * 100).toFixed(1)}%</span>
                    </td>
                </tr>
            `;
        });

        html += `
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="result-section" style="background: #fff; padding: 25px; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid #e2e8f0;">
                <h4 style="margin-top: 0; color: #1e293b; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                    <span style="background: #fff7ed; color: #ea580c; padding: 8px; border-radius: 8px;">üé≤</span>
                    Confusion Matrix
                </h4>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: separate; border-spacing: 2px;">
                        <tr>
                            <td style="padding: 8px;"></td>
        `;

        data.classes.forEach(cls => {
            html += `<td style="padding: 8px; text-align: center; font-size: 11px; font-weight: 700; color: #64748b;">Pred ${cls}</td>`;
        });
        html += '</tr>';

        data.confusion_matrix.forEach((row, i) => {
            html += `<tr><td style="padding: 8px; font-size: 11px; font-weight: 700; color: #64748b; text-align: right;">True ${data.classes[i]}</td>`;
            row.forEach((val, j) => {
                const isDiagonal = i === j;
                const bg = isDiagonal ? '#dcfce7' : '#f8fafc';
                const color = isDiagonal ? '#166534' : '#64748b';
                html += `<td style="padding: 12px; text-align: center; background: ${bg}; color: ${color}; border-radius: 6px; font-weight: 700;">${val}</td>`;
            });
            html += '</tr>';
        });

        html += `
                    </table>
                </div>
            </div>
        </div>
        `;

        document.getElementById('dtResultContent').innerHTML = html;
    }
</script>
{% endblock %}

{% block content %}
<div class="container">
    <div class="nb-wrapper">
        <div class="nb-header">
            <h2>üå≥ Klasifikasi Data menggunakan Decision Tree</h2>
            <p class="subtitle">Upload dataset CSV custom untuk analisis menggunakan Decision Tree Classifier</p>
        </div>

        <div class="nb-main-content">
            <div class="nb-left">
                <div class="card">
                    <h3 class="card-title">üì§ Upload Dataset CSV</h3>
                    <div class="csv-upload-area" id="csvUploadArea"
                        onclick="document.getElementById('csvInput').click()">
                        <input type="file" id="csvInput" accept=".csv" onchange="handleCSVUpload(event)"
                            style="display: none;">
                        <div class="upload-icon">üìä</div>
                        <p style="color: #475569; margin-bottom: 5px;">Klik atau seret & lepas file CSV</p>
                        <p style="color: #64748b; font-size: 14px;">Format: CSV dengan header</p>
                        <p style="color: #64748b; font-size: 12px; margin-top: 10px;">Kolom terakhir akan digunakan
                            sebagai
                            target/label</p>
                    </div>

                    <div id="csvInfo" class="csv-info" style="display: none; margin-top: 15px;">
                        <p><strong>File:</strong> <span id="csvFileName"></span></p>
                        <p><strong>Jumlah baris:</strong> <span id="csvRows"></span></p>
                        <p><strong>Jumlah kolom:</strong> <span id="csvCols"></span></p>
                    </div>

                    <div class="form-group" style="margin-top: 20px;">
                        <label for="test_size_dt">
                            <span class="label-icon">üìè</span>
                            Rasio Ukuran Testing
                        </label>
                        <input type="number" id="test_size_dt" value="0.3" min="0.1" max="0.5" step="0.05">
                        <small class="input-hint">Proporsi data untuk pengujian (bawaan: 30%)</small>
                    </div>

                    <div class="form-group">
                        <label for="max_depth_dt">
                            <span class="label-icon">üå≤</span>
                            Kedalaman Maksimum Tree
                        </label>
                        <select id="max_depth_dt">
                            <option value="None">None (Unlimited)</option>
                            <option value="3">3</option>
                            <option value="5">5</option>
                            <option value="7">7</option>
                            <option value="10">10</option>
                            <option value="15">15</option>
                        </select>
                        <small class="input-hint">Batasi kedalaman untuk mencegah overfitting</small>
                    </div>

                    <button id="btnProcessDT" class="process-button nb-button" onclick="processDecisionTree()" disabled>
                        üå≥ Klasifikasi dengan Decision Tree
                    </button>
                </div>

                <div class="card info-card" style="margin-top: 20px;">
                    <h3>üìö Tentang Decision Tree</h3>
                    <p><strong>Decision Tree</strong> adalah algoritma supervised learning yang menggunakan struktur
                        pohon untuk membuat keputusan.</p>
                    <p><strong>Format CSV:</strong> Header di baris pertama, kolom terakhir = kelas target</p>
                    <p><strong>Data:</strong> Semua fitur harus numerik, target berupa label kelas (0, 1, 2, ...)</p>
                    <p><strong>Metrik:</strong> Akurasi, Presisi, Recall, Skor F1, Feature Importance</p>
                    <p><strong>Contoh Dataset:</strong></p>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li><a href="/static/data/sample_iris.csv" download style="color: #667eea; font-weight: 500;">üì•
                                Iris Dataset (3 kelas)</a></li>
                        <li><a href="/static/data/sample_loan.csv" download style="color: #667eea; font-weight: 500;">üì•
                                Loan Approval (2 kelas)</a></li>
                    </ul>
                </div>
            </div>

            <div class="nb-right">
                <div id="dataPreview" class="card" style="display: none;">
                    <h3 class="card-title">üëÄ Preview Data</h3>
                    <div id="dataPreviewContent" class="data-preview-scroll"></div>
                </div>

                <div id="loadingDT" class="loading">
                    <div class="loading-spinner"></div>
                    <p>‚è≥ Memproses klasifikasi...</p>
                </div>

                <div id="resultDT" class="card" style="display: none;">
                    <h3 class="card-title">üìä Hasil Klasifikasi</h3>
                    <div id="dtResultContent"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}